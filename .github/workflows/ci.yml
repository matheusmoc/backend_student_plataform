name: CI

on:
	push:
		branches: ["master"]
	pull_request:
		branches: ["master"]

jobs:
	tests:
		name: Tests
		runs-on: ubuntu-latest
		steps:
			- name: Checkout
				uses: actions/checkout@v4

			- name: Set up Python
				uses: actions/setup-python@v5
				with:
					python-version: '3.11'

			- name: Cache pip
				uses: actions/cache@v4
				with:
					path: ~/.cache/pip
					key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
					restore-keys: |
						${{ runner.os }}-pip-

			- name: Install dependencies
				run: |
					python -m pip install --upgrade pip
					python -m pip install -r requirements.txt
					python -m pip install pytest pytest-django

			- name: Run test suite
				env:
					PYTHONDONTWRITEBYTECODE: 1
				run: |
					python app/run_tests.py

	docker-build:
		name: Docker Build
		runs-on: ubuntu-latest
		needs: [tests]
		steps:
			- name: Checkout
				uses: actions/checkout@v4

			- name: Set up Docker Buildx
				uses: docker/setup-buildx-action@v3

			- name: Build image
				run: |
					docker build -t backend-student-plataform-ci:latest .
